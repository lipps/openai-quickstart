# 保留原始布局翻译功能需求文档

## 1. 背景与目标
- 用户希望在翻译 PDF 时尽可能保留原始排版，包括多栏文本、表格、图片与背景。 
- 当前系统仅提取纯文本和表格，按顺序写入新的 PDF/Markdown，导致版面丢失。 
- 目标是在可控的复杂度下，实现包含同一页图文混排、表格和图片的布局保留输出，并提供可靠的降级策略。

## 2. 术语
- **布局保留模式（Layout Mode）**：以页面内块级布局信息为主导的翻译工作流。
- **内容块（Layout Block）**：页面上的最小可翻译单元，包含类型、位置、尺寸、字体信息及原始内容。
- **降级输出**：无法保持布局时回退到现有顺序排版模式，确保翻译完成。

## 3. 现状分析
- 解析层（`pdf_parser.py`）仅返回文本、表格列表，无坐标、字体、图片信息。
- 数据模型虽有 `ContentType.IMAGE`，但实际流程未创建或写出图片内容。
- `Writer` 组件使用 ReportLab 重新排版，无法复刻原 PDF 的布局或背景。
- GUI/API/CLI 共享 `PDFTranslator`，新增能力需同时兼容多入口。
- 缺乏针对译文膨胀、字体缺失、图像处理的策略。

## 4. 需求范围
### 4.1 功能性需求
1. **版面解析**
   - 每页识别并保存文本块、表格、图片、图形的坐标、尺寸、层级顺序。
   - 捕捉字体名称、字号、样式、颜色等关键信息；至少支持文字块的字体、字号。
   - 支持解析并存储嵌入图片的二进制数据、原始格式和坐标。
2. **翻译分片**
   - 按内容块生成翻译提示；保证多列、跨段落的阅读顺序正确。
   - 表格块按单元格或整表翻译，保留原行列结构、表头信息。
   - 提供可配置的块级合并策略（如小文本块合并）。
3. **输出重建**
   - 在新 PDF 中根据保存的坐标重绘文本、表格、图片，层级顺序应与原版一致。
   - 针对文本长度变化提供自动换行、字体缩放或列宽调整策略。
   - 保留重要背景元素（如纯色背景或简单图形），至少保证内容对齐。
   - 输出文件命名与现有逻辑兼容（`*_translated.pdf`），支持 Markdown 降级。
4. **配置与接口**
   - 新增 `layout_mode` 配置项及 CLI/GUI/API 参数开关，默认关闭。
   - GUI 显示布局模式开关与提示，历史记录中标记翻译模式与降级情况。
   - API 响应头或日志中包含布局模式执行状态。
5. **降级与错误处理**
   - 解析失败、输出失败或超时需自动回退到顺序模式，并记录原因。
   - 生成的日志与历史记录应包含失败块信息、处理耗时。

### 4.2 非功能性需求
- **性能**：布局模式处理单页的额外耗时应可配置；对大型 PDF 支持页码范围处理。
- **鲁棒性**：对翻译文本长度膨胀、字体缺失、图像解码失败提供可观测的降级途径。
- **可测试性**：提供多样的测试样例（多栏、图文混排、复杂表格）及可重复的验证脚本。
- **安全性**：移除硬编码 API Key，确保配置与环境变量优先级明确。

## 5. 约束与假设
- 依赖第三方库（建议 PyMuPDF/fpdf2 等）可被项目许可接受，GPL 兼容。
- 用户默认具备足够的本地资源；仍需避免一次性加载整本大文件至内存。
- 初期不支持复杂矢量图形编辑，仅保证文本/图片/表格对齐。

## 6. 解决方案概述
1. **版面抽取层**
   - 选型 PyMuPDF 获取 `page.get_text("dict")`、`page.get_images()` 数据，补充图片处理。
   - 新增 `LayoutBlock` 数据模型，扩展 `Book/Page` 保存坐标和样式。
2. **翻译流水线改造**
   - `PDFTranslator` 在布局模式下走新流程：按块翻译、记录翻译状态、处理多线程或批量调度。
   - 表格块沿用现有处理方式，同时保留原边框坐标。
3. **输出重建层**
   - 使用 PyMuPDF 或 ReportLab 重绘原页面：复制背景，按原坐标绘制译文文字、图片与表格。
   - 提供字体映射配置、文本自适应算法（例如基于 bbox 宽度缩放字体）。
4. **降级机制**
   - 若某块翻译或绘制失败，记录警告并回退到顺序模式输出（至少保证译文可用）。
   - GUI/日志显示回退原因，提示用户查看输出差异。
5. **配置 & 接口更新**
   - `config.yaml` 增加布局相关配置（开关、字体路径、最大缩放等）。
   - CLI/GUI/API 增加参数暴露，更新文档和帮助信息。

## 7. 实施步骤（建议）
1. **原型阶段**：使用 PyMuPDF 对样例 PDF 完成布局信息提取、简单文本重绘验证。
2. **数据模型升级**：调整 `Book/Page/Content` 结构，引入 `LayoutBlock`，更新解析与 writer 流程。
3. **翻译流程集成**：在翻译主循环中添加布局模式分支，支持块级翻译与进度上报。
4. **输出模块拓展**：开发布局模式下的 PDF 写入器，支持文本缩放与图片重绘。
5. **GUI/API 配置**：添加开关、进度显示与历史记录字段。
6. **测试与文档**：准备版面多样的 PDF 样本，编写自动化验证脚本，更新 README/使用指南。

## 8. 风险与应对
- **译文溢出导致遮挡**：实现字体缩放、动态换行、提示用户手动校正。
- **图片或矢量解析失败**：捕获异常，保留原图二进制并提示用户；必要时回退顺序模式。
- **性能瓶颈**：支持页码范围参数、并行翻译；对大文件提示用户开启批处理。
- **依赖兼容性**：评估 PyMuPDF/ReportLab 版本与发行许可，提供锁定依赖策略。

## 9. 验收标准
- 对提供的样例 PDF（含多栏文本、表格、图片）生成的译文 PDF 视觉布局与原版基本一致。
- 对于无法保留布局的页面，系统能自动降级并记录日志，输出可读译文。
- GUI、CLI、API 三入口均支持开启/关闭布局模式，配置项生效且提供用户提示。
- 所有新增配置与流程均有文档说明和测试验证记录。

