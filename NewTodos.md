# 布局保留翻译功能开发计划

## 总体目标
实现 PDF 翻译时保留原始布局，支持多栏文本、表格、图片的精确重建，并提供可靠的降级策略。

## 开发阶段与任务清单

### 阶段一：基础设施与原型验证 (1-2周)
#### 串行任务
- [ ] 评估 PyMuPDF 许可证兼容性
- [ ] 更新 requirements.txt 添加 PyMuPDF
- [ ] 验证现有环境兼容性
- [ ] 创建 PDF 布局信息提取原型脚本
- [ ] 验证 PyMuPDF 文本和图片提取功能

#### 并行任务
- [ ] 收集多样化 PDF 测试样本
- [ ] 分析现有代码 `pdf_parser.py`, `PDFTranslator`, `Writer` 组件

### 阶段二：核心数据模型设计 (1周)
#### 串行任务
- [ ] 设计 LayoutBlock 数据模型
- [ ] 扩展 Book/Page/Content 结构
- [ ] 更新序列化/反序列化逻辑

#### 并行任务
- [ ] 设计 layout_mode 配置项
- [ ] 增强布局模式日志记录系统

### 阶段三：解析层改造 (1-2周)
#### 串行任务
- [ ] 增强 PDF 解析器，支持坐标和样式提取
- [ ] 实现文本块阅读顺序识别算法
- [ ] 开发图片处理模块，处理图片解码

#### 并行任务
- [ ] 优化表格解析，改进边框和单元格坐标识别
- [ ] 实现字体映射和缺失字体降级策略

### 阶段四：翻译流程集成 (1-2周)
#### 串行任务
- [ ] 调整 `PDFTranslator` 支持布局模式
- [ ] 实现按块翻译流程
- [ ] 开发文本块合并策略
- [ ] 添加翻译超时和错误处理机制

#### 并行任务
- [ ] 实现布局模式翻译进度追踪
- [ ] 设计多线程翻译安全机制

### 阶段五：输出重建系统 (2-3周)
#### 串行任务
- [ ] 实现文本按原坐标重绘
- [ ] 开发字体缩放和文本溢出处理
- [ ] 重建图片和表格，保持原始坐标
- [ ] 复制页面背景和简单图形

#### 并行任务
- [ ] 开发文本自适应算法（字体缩放、换行）
- [ ] 创建布局对比和质量评估工具

### 阶段六：降级机制与错误处理 (1周)
#### 串行任务
- [ ] 实现自动回退到顺序模式的逻辑
- [ ] 完善错误日志记录
- [ ] 添加超时控制和资源清理机制

#### 并行任务
- [ ] 完善错误日志和性能监控系统
- [ ] 验证配置项有效性

### 阶段七：接口集成 (1-2周)
#### 并行任务
- [ ] 更新 CLI 接口，添加 layout_mode 参数
- [ ] 更新 GUI 接口，添加布局模式开关
- [ ] 更新 REST API，支持布局模式
- [ ] 更新 config.yaml 和配置加载逻辑

### 阶段八：测试与优化 (2-3周)
#### 并行任务
- [ ] 为新模块编写单元测试
- [ ] 进行完整流程集成测试
- [ ] 测试大文件处理性能和内存使用
- [ ] 进行用户验收测试

#### 串行任务
- [ ] 根据性能测试结果优化代码
- [ ] 实现页码范围处理和内存优化
- [ ] 更新 README 和使用文档
- [ ] 编写详细 API 文档和配置说明

## 风险控制点
1. **技术可行性**: 阶段一完成原型验证
2. **性能评估**: 阶段三后进行性能基准测试
3. **兼容性**: 阶段六前完成降级机制
4. **用户体验**: 阶段七后进行用户测试

## 关键里程碑
- **里程碑1** (2周): 原型验证完成，技术路线确认
- **里程碑2** (4周): 核心解析和翻译功能完成
- **里程碑3** (7周): 基本布局重建功能完成
- **里程碑4** (10周): 完整功能集成，开始测试阶段

## 预期总工期
**10-14周**（约3-4个月）

## 附加说明
- 实际进度可能因技术复杂度和资源可用性有所调整
- 建议设置定期检查点，评估进展和调整计划
- 保持与利益相关者的持续沟通
